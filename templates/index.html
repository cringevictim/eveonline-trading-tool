<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVE Trading Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-card-hover: #1a2332;
            --border: #1e3a5f;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --profit: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --highsec: #10b981;
            --lowsec: #f59e0b;
            --nullsec: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            font-size: 125%; /* Scale everything by 1.25x */
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 25px; }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }

        .subtitle { color: var(--text-muted); font-size: 1rem; margin-top: 5px; }

        /* Control Panels */
        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .controls-row-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .control-panel {
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--profit);
            border-radius: 50%;
            animation: pulse-live 2s infinite;
            box-shadow: 0 0 8px var(--profit);
        }
        
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .panel-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .panel-toggle input { 
            width: 16px; 
            height: 16px; 
            accent-color: var(--accent);
            cursor: pointer;
        }

        .panel-content.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .form-grid-5 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.span-2 { grid-column: span 2; }

        .checkbox-col {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: center;
        }
        
        .form-group.checkbox-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .form-group.checkbox-group label:first-child {
            margin-bottom: 8px;
        }

        /* Security status dots */
        .sec-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            flex-shrink: 0;
        }
        .sec-dot.highsec { background: var(--highsec); }
        .sec-dot.lowsec { background: var(--lowsec); }
        .sec-dot.nullsec { background: var(--nullsec); }

        label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="text"], input[type="number"], select {
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            width: 100%;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        input.error { border-color: var(--danger); }

        .checkbox-row {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .checkbox-item input { 
            width: 16px; 
            height: 16px; 
            accent-color: var(--accent);
            cursor: pointer;
        }

        .checkbox-item.highsec label { color: var(--highsec); }
        .checkbox-item.lowsec label { color: var(--lowsec); }
        .checkbox-item.nullsec label { color: var(--nullsec); }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle.active { background: var(--accent); border-color: var(--accent); }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--text);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle.active::after { left: 20px; background: var(--bg-dark); }

        .info-text { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; }

        /* Character Panel in Main Content */
        .char-panel { padding: 15px 20px; }
        
        .char-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .char-top-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .char-portrait {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            border: 2px solid var(--accent);
            flex-shrink: 0;
            box-shadow: 0 0 12px var(--accent-glow);
        }
        
        .char-name-block {
            flex: 1;
        }
        
        .char-pilot-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 700;
        }
        
        .char-ship-name {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .char-bar {
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-left: 3px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .char-bar.wallet-bar {
            border-left-color: var(--profit);
        }
        
        .char-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .char-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .char-value.wallet {
            font-family: 'Orbitron', sans-serif;
            color: var(--profit);
            font-weight: 700;
            font-size: 1rem;
        }
        
        .char-fees-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .char-fee {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-left: 3px solid var(--warning);
        }
        
        .fee-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .fee-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--warning);
        }
        
        .logout-link {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-decoration: none;
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .logout-link:hover { 
            color: var(--danger); 
            border-color: var(--danger);
        }
        
        .login-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .login-btn-inline {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            color: var(--bg-dark);
            text-decoration: none;
            border-radius: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            transition: all 0.2s;
        }
        
        .login-btn-inline:hover {
            box-shadow: 0 4px 15px var(--accent-glow);
            transform: translateY(-1px);
        }
        
        .sync-btns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            grid-column: span 3;
        }
        
        .sync-btn-inline:hover {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
        }
        
        .sync-btn-inline.danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .sync-btn-inline.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* Settings Form in Right Panel */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .setting-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .setting-row label {
            font-size: 0.65rem;
        }
        
        .setting-row-half {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .setting-half {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .setting-half label {
            font-size: 0.65rem;
        }
        
        .sync-btn-sm {
            padding: 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sync-btn-sm:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .sync-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .sync-btn-inline {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-muted);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sync-btn-inline:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Scan Button */
        .scan-btn-wrapper { margin-bottom: 25px; }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            color: var(--bg-dark);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--accent-glow);
        }

        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-stop { background: linear-gradient(135deg, var(--danger), #dc2626); }
        .btn-stop:hover { box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3); }

        /* Status Bar */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 90px;
            flex-shrink: 0;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
            flex-shrink: 0;
        }

        .status-dot.idle { background: var(--text-muted); }
        .status-dot.scanning { background: var(--warning); animation: pulse 1.5s infinite; }
        .status-dot.complete { background: var(--profit); }
        .status-dot.stopped { background: var(--danger); }
        .status-dot.error { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }

        .progress-wrapper { 
            flex: 1; 
            min-width: 150px;
        }

        .progress-bar-bg {
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        .current-item {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 180px;
            min-width: 100px;
            max-width: 180px;
            flex-shrink: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats { 
            display: flex; 
            gap: 20px; 
            flex-shrink: 0;
        }

        .stat { text-align: center; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--accent); }
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

        .data-age { min-width: 70px; }
        .data-age .stat-value { transition: color 0.3s; min-width: 50px; text-align: center; }
        .data-age.fresh .stat-value { color: var(--profit); }
        .data-age.stale .stat-value { color: var(--warning); }
        .data-age.old .stat-value { color: var(--danger); }


        /* Table */
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
            table-layout: fixed;
        }

        .trades-table th {
            padding: 10px 8px;
            text-align: left;
            background: rgba(0, 212, 255, 0.1);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .trades-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .trades-table th.sortable:hover {
            color: var(--accent);
            background: rgba(0, 212, 255, 0.15);
        }

        .trades-table th.sortable.active {
            color: var(--accent);
        }

        .trades-table th .sort-arrow {
            opacity: 0;
            margin-left: 3px;
            font-size: 0.6rem;
        }

        .trades-table th.sortable.active .sort-arrow {
            opacity: 1;
        }

        .trades-table th.sortable.desc .sort-arrow { display: inline; }
        .trades-table th.sortable.asc .sort-arrow { display: inline; transform: rotate(180deg); }

        .trades-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(30, 58, 95, 0.4);
            font-size: 0.8rem;
        }

        /* Column widths - 9 columns now */
        .trades-table th:nth-child(1), .trades-table td:nth-child(1) { width: 14%; } /* Item */
        .trades-table th:nth-child(2), .trades-table td:nth-child(2) { width: 8%; }  /* Profit */
        .trades-table th:nth-child(3), .trades-table td:nth-child(3) { width: 7%; }  /* Time */
        .trades-table th:nth-child(4), .trades-table td:nth-child(4) { width: 8%; }  /* ISK/h */
        .trades-table th:nth-child(5), .trades-table td:nth-child(5) { width: 8%; }  /* ISK/j */
        .trades-table th:nth-child(6), .trades-table td:nth-child(6) { width: 5%; }  /* Jumps */
        .trades-table th:nth-child(7), .trades-table td:nth-child(7) { width: 6%; }  /* Trips */
        .trades-table th:nth-child(8), .trades-table td:nth-child(8) { width: 8%; }  /* Qty */
        .trades-table th:nth-child(9), .trades-table td:nth-child(9) { width: 36%; } /* Route */

        .trades-table tr:hover { background: var(--bg-card-hover); }
        .trades-table tr:last-child td { border-bottom: none; }
        .trades-table tr.selected { 
            background: rgba(0, 212, 255, 0.15) !important; 
        }

        .item-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profit { color: var(--profit); font-weight: 700; font-size: 0.75rem; }
        .isk-hour { color: #f472b6; font-weight: 600; font-size: 0.75rem; }
        .isk-jump { color: var(--accent); font-weight: 600; font-size: 0.75rem; }
        .time-cell { color: var(--text-muted); font-size: 0.7rem; white-space: nowrap; }

        .badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        .jumps-badge { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .trips-badge { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .amount-badge { background: rgba(16, 185, 129, 0.15); color: var(--profit); font-size: 0.7rem; }
        .single-trip-badge { background: rgba(0, 212, 255, 0.15); color: var(--accent); font-size: 0.7rem; }

        .efficiency-boost { color: var(--profit); font-size: 0.65rem; font-weight: 600; display: block; }
        .variant-label { font-size: 0.6rem; color: var(--text-muted); }
        .full-order-label { font-size: 0.6rem; color: var(--text-muted); }

        .trade-variant { background: rgba(0, 212, 255, 0.02); }

        .route { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
        }
        .route-station {
            display: inline-block;
            max-width: 42%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
        .route-arrow { 
            color: var(--accent); 
            margin: 0 3px;
        }

        .empty-state { text-align: center; padding: 50px; color: var(--text-muted); }
        .empty-state h3 { font-family: 'Orbitron', sans-serif; margin-bottom: 8px; font-size: 1rem; }

        .error-msg {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
        }

        .error-msg.show { display: block; }

        /* Character Panel */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left { flex: 1; }
        .header-center { 
            flex: 2; 
            text-align: center; 
        }
        .header-right { 
            flex: 1; 
            display: flex; 
            justify-content: flex-end; 
        }

        .character-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .character-portrait {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            border: 2px solid var(--accent);
        }

        .character-info {
            text-align: left;
        }

        .character-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
        }

        .character-location {
            font-size: 0.75rem;
            color: var(--text-muted);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .character-wallet {
            font-size: 0.8rem;
            color: var(--profit);
            font-weight: 600;
        }

        .login-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--accent-glow);
        }

        .char-status-card {
            position: relative;
        }

        .logout-corner {
            position: absolute;
            top: 48px;
            right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .logout-corner:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .selected-deal {
            position: relative;
        }

        .clear-corner {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-corner.visible {
            display: flex;
        }

        .clear-corner:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .action-btn {
            padding: 3px 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .trade-actions {
            display: flex;
            gap: 5px;
            margin-top: 3px;
        }

        /* ========== Status Panel ========== */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .main-content { min-width: 0; }

        .status-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .status-card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-card-title .live-dot {
            width: 8px;
            height: 8px;
            background: var(--profit);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .char-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .char-portrait-lg {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            border: 2px solid var(--accent);
        }

        .char-details { flex: 1; }

        .char-name-lg {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--accent);
        }

        .char-ship {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .status-item.full { grid-column: span 2; }

        .status-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--text);
            margin-top: 3px;
        }

        .status-value.profit { color: var(--profit); }
        .status-value.warning { color: var(--warning); }
        .status-value.accent { color: var(--accent); }
        .status-value.small { font-size: 0.85rem; }

        .location-value {
            font-size: 0.8rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .docked-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--profit);
            color: var(--bg-dark);
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 5px;
        }

        .in-space-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--warning);
            color: var(--bg-dark);
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 5px;
        }

        /* Selected Deal */
        .selected-deal {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--accent);
        }

        .deal-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 8px;
        }

        .deal-route {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .deal-route-arrow { color: var(--accent); margin: 0 5px; }

        .deal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .deal-stat {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .deal-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            color: var(--accent);
        }

        .deal-stat-value.profit {
            color: var(--profit);
        }

        .deal-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .route-warning {
            border-radius: 6px;
            padding: 8px 10px;
            margin-top: 10px;
            font-size: 0.75rem;
        }

        .route-warning.danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .route-warning.safe {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--profit);
            color: var(--profit);
        }

        .route-warning .warning-icon,
        .route-warning .safe-icon {
            font-weight: bold;
            margin-right: 5px;
        }

        .deal-progress {
            margin-bottom: 12px;
        }

        .deal-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .deal-progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .deal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--profit));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .no-deal {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .no-deal-icon { 
            font-size: 1.5rem; 
            margin-bottom: 10px;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
        }

        /* Action Buttons Panel */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .action-btn-lg {
            padding: 8px 10px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap;
        }

        .action-btn-lg:hover:not(:disabled) {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent);
        }

        .action-btn-lg:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-btn-lg.primary {
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            color: var(--bg-dark);
            border: none;
            font-weight: 700;
        }

        .action-btn-lg.primary:hover:not(:disabled) {
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .action-btn-lg.full { grid-column: span 2; }

        .action-btn-lg.highlight {
            background: linear-gradient(135deg, var(--profit), #22c55e);
            color: var(--bg-dark);
            border: none;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
        }

        .action-btn-lg.highlight:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            transform: translateY(-1px);
        }

        .action-btn-lg.danger { border-color: var(--danger); color: var(--danger); }
        .action-btn-lg.danger:hover:not(:disabled) { background: rgba(239, 68, 68, 0.2); }

        .login-prompt {
            text-align: center;
            padding: 20px 15px;
        }

        .login-prompt-icon { 
            font-size: 1.5rem; 
            margin-bottom: 10px;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
        }

        .login-prompt-text {
            color: var(--text-muted);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .fees-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .fee-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .fee-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--warning);
        }



        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .status-panel {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 1200px) {
            .controls-row-main { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .form-grid, .form-grid-3 { grid-template-columns: 1fr; }
            .stats { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EVE TRADING TOOL</h1>
            <p class="subtitle">Market Scanner & Profit Calculator</p>
        </header>

        <div class="main-layout">
        <!-- Main Content -->
        <div class="main-content">

        <div class="controls-wrapper">
            <!-- Row 1: Character Status + Market Settings side by side -->
            <div class="controls-row-main">
                <!-- Character Status Panel (Left Half) -->
                {% if character %}
                <div class="control-panel char-panel">
                    <div class="panel-header">
                        <span class="panel-title">
                            <span class="live-dot"></span>
                            Character Status
                        </span>
                        <a href="/logout" class="logout-link" title="Logout">Logout</a>
                    </div>
                    <div class="char-content">
                        <!-- Row 1: Portrait + Name/Ship -->
                        <div class="char-top-row">
                            <img class="char-portrait" src="{{ character.portrait }}" alt="Portrait" id="charPortrait">
                            <div class="char-name-block">
                                <div class="char-pilot-name" id="charName">{{ character.name }}</div>
                                <div class="char-ship-name" id="charShip">Loading ship...</div>
                            </div>
                        </div>
                        <!-- Row 2: Location (full width) -->
                        <div class="char-bar">
                            <span class="char-value" id="charLocation">Loading...</span>
                        </div>
                        <!-- Row 3: Wallet (full width) -->
                        <div class="char-bar wallet-bar">
                            <span class="char-label">Wallet</span>
                            <span class="char-value wallet" id="charWallet">-</span>
                        </div>
                        <!-- Row 4: Fees side by side -->
                        <div class="char-fees-row">
                            <div class="char-fee">
                                <span class="fee-label">Broker Fee</span>
                                <span class="fee-value" id="brokerFee">3.0%</span>
                            </div>
                            <div class="char-fee">
                                <span class="fee-label">Sales Tax</span>
                                <span class="fee-value" id="salesTax">8.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="control-panel">
                    <div class="panel-header">
                        <span class="panel-title">Character</span>
                    </div>
                    <div class="login-inline">
                        <span>Login to sync wallet, set destinations & more</span>
                        <a href="/login" class="login-btn-inline">&gt; Login with EVE</a>
                    </div>
                </div>
                {% endif %}

                <!-- Market Settings Panel (Right Half) -->
                <div class="control-panel">
                    <div class="panel-header">
                        <span class="panel-title">Market Settings</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Market Group</label>
                            <select id="groupSelect">
                                {% for key, group in groups.items() %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Min Profit (M)</label>
                            <input type="text" id="minProfit" value="10" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label>Max Budget (M)</label>
                            <input type="text" id="maxBudget" value="500" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label>Max Cargo (M3)</label>
                            <input type="text" id="cargoCapacity" value="5 000" placeholder="5 000">
                        </div>
                        <div class="form-group">
                            <label>Max Qty</label>
                            <input type="number" id="maxQty" value="" placeholder="-" step="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>Max Trips</label>
                            <input type="text" id="maxTrips" value="" placeholder="-">
                        </div>
                        <div class="form-group">
                            <label>Max Jumps</label>
                            <input type="text" id="maxJumps" value="" placeholder="-">
                        </div>
                        <div class="form-group sync-btns">
                            <button class="sync-btn-inline" id="btnSyncWallet" onclick="syncWallet()">Sync Wallet</button>
                            <button class="sync-btn-inline" id="btnSyncCargo" onclick="syncCargo()">Sync Cargo</button>
                            <button class="sync-btn-inline danger" id="btnClearDB" onclick="clearDatabase()">Clear DB</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Route & Trade Options -->
            <div class="control-panel">
                <div class="panel-header">
                    <span class="panel-title">Route & Trade Options</span>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Route Safety</label>
                        <select id="routeFlag">
                            {% for key, name in route_options.items() %}
                            <option value="{{ key }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trade Mode</label>
                        <select id="tradeMode">
                            {% for key, name in trade_modes.items() %}
                            <option value="{{ key }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <label>Include Regions</label>
                        <div class="checkbox-col">
                            <div class="checkbox-item highsec">
                                <input type="checkbox" id="regionHighsec" checked>
                                <label for="regionHighsec">Highsec</label>
                            </div>
                            <div class="checkbox-item lowsec">
                                <input type="checkbox" id="regionLowsec">
                                <label for="regionLowsec">Lowsec</label>
                            </div>
                            <div class="checkbox-item nullsec">
                                <input type="checkbox" id="regionNullsec">
                                <label for="regionNullsec">Nullsec</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Button -->
        <div class="scan-btn-wrapper">
            <button class="btn btn-primary" id="scanBtn" onclick="toggleScan()">Start Market Scan</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot idle" id="statusDot"></div>
                <span id="statusText">Idle</span>
            </div>
            <div class="progress-wrapper">
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            <span class="current-item" id="currentItem"></span>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="ordersCount">0</div>
                    <div class="stat-label">Orders</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="tradesCount">0</div>
                    <div class="stat-label">Trades</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="routesCount">0</div>
                    <div class="stat-label">Routes</div>
                </div>
                <div class="stat data-age" id="dataAgeBlock">
                    <div class="stat-value" id="dataAge">-</div>
                    <div class="stat-label">Data Age</div>
                </div>
            </div>
        </div>

        <!-- Trades Table -->
        <table class="trades-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="type_name" title="Item name">Item</th>
                    <th class="sortable active desc" data-sort="profit" title="Total profit from this trade">Profit <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="cost" title="Total ISK needed to buy goods">Budget <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="profit_per_jump" title="Profit per jump (efficiency)">ISK/j <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="jumps" title="Number of jumps one way">Jumps <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="trips" title="Round trips needed to move all goods">Trips <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="amount" title="Quantity of items">Qty <span class="sort-arrow">v</span></th>
                    <th class="sortable" data-sort="distance" title="Click to sort by closest buy station">Route <span class="sort-arrow">v</span></th>
                </tr>
            </thead>
            <tbody id="tradesBody">
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <h3>No trades found</h3>
                            <p>Configure settings and start a scan</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        </div><!-- End main-content -->

        <!-- Status Panel (Right Side) -->
        <div class="status-panel">
            <!-- Selected Deal Card -->
            <div class="status-card selected-deal" id="selectedDealCard">
                <button class="clear-corner" id="btnClearDeal" onclick="clearDeal()" title="Clear selection">x</button>
                <div class="status-card-title">Selected Deal</div>
                <div id="selectedDealContent">
                    <div class="no-deal">
                        <div class="no-deal-icon">&gt;&gt;</div>
                        <div>Click a trade to select it</div>
                    </div>
                </div>
                <div class="route-warning" id="routeWarning" style="display: none;"></div>
            </div>

            <!-- Actions Card (only visible when deal selected) -->
            <div class="status-card" id="quickActionsCard" style="display: none;">
                <div class="status-card-title">Quick Actions</div>
                <div class="action-buttons">
                    <button class="action-btn-lg" id="btnSetBuyDest" onclick="setDestination('buy')">
                        Go to Buy
                    </button>
                    <button class="action-btn-lg" id="btnSetSellDest" onclick="setDestination('sell')">
                        Go to Sell
                    </button>
                    <button class="action-btn-lg full" id="btnOpenMarket" onclick="openMarketForDeal()">
                        Open Market Details
                    </button>
                </div>
            </div>

            <!-- Deal Progress Card (hidden until deal started) -->
            <div class="status-card" id="dealProgressCard" style="display: none;">
                <div class="status-card-title">[~] Deal Progress</div>
                <div class="deal-progress">
                    <div class="deal-progress-label">
                        <span id="progressPhase">Phase 1: Travel to Buy</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="deal-progress-bar">
                        <div class="deal-progress-fill" id="dealProgressFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Est. Time Left</div>
                        <div class="status-value small" id="estTimeLeft">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Est. Profit</div>
                        <div class="status-value profit small" id="estProfit">-</div>
                    </div>
                </div>
            </div>

        </div><!-- End status-panel -->
        </div><!-- End main-layout -->
    </div><!-- End container -->

    <script>
        let currentSort = 'profit_per_jump';
        let sortDirection = 'desc'; // 'asc' or 'desc'
        let isScanning = false;
        let pollInterval;
        let isLoggedIn = {{ 'true' if character else 'false' }};
        let characterData = null;
        let selectedDeal = null;
        let activeDeal = null;
        let allTradesCache = [];
        let characterStatusInterval = null;
        let lastUpdatedTimestamp = null;
        let dataAgeInterval = null;
        let lastKnownWallet = null;

        // ========== Number Formatting ==========
        
        function formatNumberCompact(num) {
            if (num === undefined || num === null || isNaN(num)) return '0';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return Math.round(num).toString();
        }

        function formatNumber(num) {
            if (num === undefined || num === null || isNaN(num)) return '0';
            return formatNumberCompact(num);
        }

        function formatWithSpaces(num) {
            if (num === '' || num === null || num === undefined || isNaN(num)) return '';
            return Math.floor(Number(num)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        function parseSpacedNumber(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/\s/g, '').replace(/,/g, '')) || 0;
        }

        function getSecurityClass(security) {
            if (security === undefined || security === null) return 'highsec';
            if (security >= 0.5) return 'highsec';
            if (security > 0) return 'lowsec';
            return 'nullsec';
        }

        function formatSecurity(security) {
            if (security === undefined || security === null) return '';
            return security.toFixed(1);
        }

        // ========== Input Helpers ==========

        function getInputValue(id, defaultVal) {
            const el = document.getElementById(id);
            if (!el) return defaultVal;
            const val = parseSpacedNumber(el.value);
            return val > 0 ? val : defaultVal;
        }

        function getCargoCapacity() { return getInputValue('cargoCapacity', 5000); }
        function getBudget() { 
            const val = parseFloat(document.getElementById('maxBudget')?.value) || 0;
            return val > 0 ? val * 1000000 : Infinity; // Convert millions to actual ISK
        }
        function getMinProfit() { 
            const val = parseFloat(document.getElementById('minProfit')?.value) || 10;
            return val * 1000000; // Convert millions to actual ISK
        }
        function getMaxTrips() {
            const val = parseInt(document.getElementById('maxTrips')?.value);
            return val > 0 ? val : Infinity;
        }
        function getMaxJumps() {
            const val = parseInt(document.getElementById('maxJumps')?.value);
            return val > 0 ? val : Infinity;
        }
        function getMaxQty() {
            const val = parseSpacedNumber(document.getElementById('maxQty')?.value);
            return val > 0 ? val : Infinity;
        }

        function getSelectedRegions() {
            const regions = [];
            if (document.getElementById('regionHighsec').checked) regions.push('highsec');
            if (document.getElementById('regionLowsec').checked) regions.push('lowsec');
            if (document.getElementById('regionNullsec').checked) regions.push('nullsec');
            return regions.length > 0 ? regions : ['highsec'];
        }

        // ========== Trade Processing ==========

        function adjustTradeForBudget(trade, budget, cargoCapacity) {
            // Safety checks for invalid trade data
            if (!trade || !trade.amount || trade.amount <= 0) return [];
            if (!trade.buy_price || trade.buy_price <= 0) return [];
            if (!trade.sell_price) return [];
            
            const costPerUnit = trade.buy_price;
            const profitPerUnit = trade.sell_price - trade.buy_price;
            const volumePerUnit = (trade.volume_m3 && trade.amount) ? trade.volume_m3 / trade.amount : 1;
            
            // Handle infinite budget (no limit)
            const maxAffordable = (budget === Infinity || !isFinite(budget) || budget <= 0) 
                ? trade.amount 
                : Math.floor(budget / costPerUnit);
            const adjustedAmount = Math.min(trade.amount, maxAffordable);
            
            if (adjustedAmount <= 0) return [];
            
            const adjustedCost = adjustedAmount * costPerUnit;
            const adjustedProfit = adjustedAmount * profitPerUnit;
            const adjustedVolume = adjustedAmount * volumePerUnit;
            const adjustedTrips = Math.ceil(adjustedVolume / cargoCapacity);
            const adjustedTotalJumps = trade.jumps * 2 * adjustedTrips;
            const adjustedProfitPerJump = adjustedTotalJumps > 0 ? adjustedProfit / adjustedTotalJumps : adjustedProfit;
            
            const results = [];
            
            results.push({
                ...trade,
                amount: adjustedAmount,
                cost: adjustedCost,
                profit: adjustedProfit,
                volume_m3: adjustedVolume,
                trips: adjustedTrips,
                total_jumps: adjustedTotalJumps,
                profit_per_jump: adjustedProfitPerJump,
                original_amount: trade.amount,
                variant: 'full',
                has_single_trip_option: adjustedTrips > 1
            });
            
            // Single trip variant if multiple trips needed
            if (adjustedTrips > 1) {
                const maxUnitsPerTrip = Math.floor(cargoCapacity / volumePerUnit);
                const singleTripAmount = Math.min(maxUnitsPerTrip, adjustedAmount);
                const budgetLimitedAmount = (budget === Infinity || !isFinite(budget)) 
                    ? singleTripAmount 
                    : Math.floor(budget / costPerUnit);
                const finalSingleTripAmount = Math.min(singleTripAmount, budgetLimitedAmount);
                
                if (finalSingleTripAmount > 0) {
                    const singleTripCost = finalSingleTripAmount * costPerUnit;
                    const singleTripProfit = finalSingleTripAmount * profitPerUnit;
                    const singleTripVolume = finalSingleTripAmount * volumePerUnit;
                    const singleTripTotalJumps = trade.jumps * 2;
                    const singleTripProfitPerJump = singleTripTotalJumps > 0 ? singleTripProfit / singleTripTotalJumps : singleTripProfit;
                    
                    const efficiencyBoost = ((singleTripProfitPerJump / adjustedProfitPerJump) - 1) * 100;
                    
                    results.push({
                        ...trade,
                        amount: finalSingleTripAmount,
                        cost: singleTripCost,
                        profit: singleTripProfit,
                        volume_m3: singleTripVolume,
                        trips: 1,
                        total_jumps: singleTripTotalJumps,
                        profit_per_jump: singleTripProfitPerJump,
                        original_amount: trade.amount,
                        variant: 'single_trip',
                        efficiency_boost: efficiencyBoost,
                        full_trips: adjustedTrips
                    });
                }
            }
            
            return results;
        }

        // ========== Validation ==========

        function validateFields() {
            let valid = true;
            const errors = [];
            
            const minProfit = getMinProfit();
            const cargo = getCargoCapacity();
            const budget = getBudget();
            
            document.querySelectorAll('input.error').forEach(el => el.classList.remove('error'));
            
            if (minProfit <= 0) {
                document.getElementById('minProfit').classList.add('error');
                errors.push('Min Profit must be greater than 0');
                valid = false;
            }
            
            if (cargo <= 0) {
                document.getElementById('cargoCapacity').classList.add('error');
                errors.push('Cargo Capacity must be greater than 0');
                valid = false;
            }
            
            if (budget <= 0) {
                document.getElementById('maxBudget').classList.add('error');
                errors.push('Max Budget must be greater than 0');
                valid = false;
            }
            
            const errorMsg = document.getElementById('errorMsg');
            if (errors.length > 0) {
                errorMsg.textContent = errors.join('. ');
                errorMsg.classList.add('show');
            } else {
                errorMsg.classList.remove('show');
            }
            
            return valid;
        }

        // ========== Scanning ==========

        async function toggleScan() {
            if (isScanning) {
                await stopScan();
            } else {
                if (validateFields()) {
                    await startScan();
                }
            }
        }

        async function startScan() {
            // Clear trades display immediately when starting new scan
            allTradesCache = [];
            renderTrades([]);
            
            const response = await fetch('/api/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    group_id: document.getElementById('groupSelect').value,
                    min_profit: getMinProfit(),
                    cargo_capacity: getCargoCapacity(),
                    regions: getSelectedRegions(),
                    route_flag: document.getElementById('routeFlag').value,
                    trade_mode: document.getElementById('tradeMode').value
                })
            });

            if (response.ok) {
                isScanning = true;
                updateScanButton();
                startPolling();
            }
        }

        async function stopScan() {
            await fetch('/api/stop');
            isScanning = false;
            clearInterval(pollInterval);
            updateScanButton();
            updateStatusDisplay('stopped', 0, '');
        }

        function updateScanButton() {
            const btn = document.getElementById('scanBtn');
            if (isScanning) {
                btn.textContent = ' Stop Scan';
                btn.classList.add('btn-stop');
            } else {
                btn.textContent = 'Start Market Scan';
                btn.classList.remove('btn-stop');
            }
        }

        function startPolling() {
            pollInterval = setInterval(updateStatus, 1000);
        }

        function updateStatusDisplay(status, progress, currentItem) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            const currentItemEl = document.getElementById('currentItem');
            
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            progressBar.style.width = progress + '%';
            currentItemEl.textContent = currentItem;
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                updateStatusDisplay(data.status, data.progress, data.current_item);

                document.getElementById('ordersCount').textContent = formatNumber(data.orders);
                document.getElementById('tradesCount').textContent = formatNumber(data.trades);
                document.getElementById('routesCount').textContent = formatNumber(data.cached_routes);

                // Track when data was last updated
                if (data.last_updated) {
                    lastUpdatedTimestamp = data.last_updated;
                    updateDataAge();
                    
                    // Start data age ticker if not running
                    if (!dataAgeInterval) {
                        dataAgeInterval = setInterval(updateDataAge, 1000);
                    }
                }

                if (data.status === 'complete' || data.status === 'error' || data.status === 'stopped') {
                    clearInterval(pollInterval);
                    isScanning = false;
                    updateScanButton();
                    loadTrades();
                }

                if (data.trades > 0) {
                    loadTrades();
                }
            } catch (e) {
                console.error('Status update failed:', e);
            }
        }

        function updateDataAge() {
            if (!lastUpdatedTimestamp) {
                document.getElementById('dataAge').textContent = '-';
                return;
            }
            
            const now = Date.now() / 1000;
            const ageSeconds = Math.floor(now - lastUpdatedTimestamp);
            const block = document.getElementById('dataAgeBlock');
            const ageEl = document.getElementById('dataAge');
            
            // Format the age
            let ageText;
            if (ageSeconds < 60) {
                ageText = `${ageSeconds}s`;
            } else if (ageSeconds < 3600) {
                const mins = Math.floor(ageSeconds / 60);
                const secs = ageSeconds % 60;
                ageText = `${mins}m${secs}s`;
            } else {
                const hours = Math.floor(ageSeconds / 3600);
                const mins = Math.floor((ageSeconds % 3600) / 60);
                ageText = `${hours}h${mins}m`;
            }
            
            ageEl.textContent = ageText;
            
            // Color code: green < 2min, yellow 2-5min, red > 5min
            block.classList.remove('fresh', 'stale', 'old');
            if (ageSeconds < 120) {
                block.classList.add('fresh');
            } else if (ageSeconds < 300) {
                block.classList.add('stale');
            } else {
                block.classList.add('old');
            }
        }

        // ========== Load Trades ==========

        async function loadTrades() {
            try {
                const response = await fetch('/api/trades?sort=profit_per_jump&limit=1000');
                let rawTrades = await response.json();
                
                const budget = getBudget();
                const cargoCapacity = getCargoCapacity();
                const minProfit = getMinProfit();
                
                let allTrades = [];
                rawTrades.forEach(trade => {
                    try {
                        const variants = adjustTradeForBudget(trade, budget, cargoCapacity);
                        variants.forEach(v => {
                            if (v && v.profit !== undefined && !isNaN(v.profit) && v.profit >= 0) {
                                allTrades.push(v);
                            }
                        });
                    } catch (e) {
                        console.error('Error processing trade:', trade.type_name, e);
                    }
                });
                
                // Filter by min profit
                if (minProfit > 0) {
                    allTrades = allTrades.filter(t => t.profit >= minProfit);
                }
                
                // Filter by max trips
                const maxTrips = getMaxTrips();
                if (maxTrips < Infinity && maxTrips > 0) {
                    allTrades = allTrades.filter(t => !t.trips || t.trips <= maxTrips);
                }
                
                // Filter by max jumps
                const maxJumps = getMaxJumps();
                if (maxJumps < Infinity && maxJumps > 0) {
                    allTrades = allTrades.filter(t => !t.jumps || t.jumps <= maxJumps);
                }
                
                // Filter by max quantity
                const maxQty = getMaxQty();
                if (maxQty < Infinity && maxQty > 0) {
                    allTrades = allTrades.filter(t => !t.amount || t.amount <= maxQty);
                }
                
                // Multi-criteria sort: primary sort, then secondary by profit (desc) or jumps (asc)
                allTrades.sort((a, b) => {
                    const valA = a[currentSort] || 0;
                    const valB = b[currentSort] || 0;
                    const primaryCompare = sortDirection === 'desc' ? valB - valA : valA - valB;
                    
                    // If equal, use secondary sort
                    if (primaryCompare === 0) {
                        // If sorting by jumps/trips, secondary sort by profit desc
                        if (currentSort === 'jumps' || currentSort === 'trips') {
                            return (b.profit || 0) - (a.profit || 0);
                        }
                        // Otherwise secondary sort by jumps asc
                        return (a.jumps || 0) - (b.jumps || 0);
                    }
                    return primaryCompare;
                });
                allTrades = allTrades.slice(0, 150);

                renderTrades(allTrades);
            } catch (e) {
                console.error('Load trades failed:', e);
            }
        }

        function renderTrades(trades) {
            const tbody = document.getElementById('tradesBody');
            allTradesCache = trades;
            
            if (trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <h3>No trades found</h3>
                                <p>Configure settings and start a scan</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = trades.map((trade, index) => {
                const isSingleTrip = trade.variant === 'single_trip';
                const isSelected = selectedDeal && selectedDeal.type_id === trade.type_id && 
                                   selectedDeal.from_station_id === trade.from_station_id &&
                                   selectedDeal.variant === trade.variant;
                const selectedClass = isSelected ? 'selected' : '';
                
                let itemLabel = trade.type_name;
                let tripsBadge = `<span class="badge trips-badge" title="Round trips needed">${trade.trips}</span>`;
                
                if (isSingleTrip) {
                    itemLabel = `<span class="variant-label">1-trip</span> ${trade.type_name}`;
                    const boostPct = trade.efficiency_boost ? trade.efficiency_boost.toFixed(0) : '0';
                    tripsBadge = `<span class="badge single-trip-badge" title="Single trip variant">1</span><span class="efficiency-boost" title="Efficiency boost vs full order">+${boostPct}%</span>`;
                } else if (trade.has_single_trip_option) {
                    itemLabel = `<span class="full-order-label">full</span> ${trade.type_name}`;
                }
                
                // Build quantity tooltip
                const qtyTooltip = trade.original_amount > trade.amount 
                    ? `Adjusted: ${trade.amount} / Original: ${trade.original_amount} (limited by budget)`
                    : `Quantity: ${trade.amount}`;
                const qtyDisplay = trade.original_amount > trade.amount 
                    ? `${formatAmountCompact(trade.amount)}/${formatAmountCompact(trade.original_amount)}`
                    : formatAmountCompact(trade.amount);
                
                return `
                <tr class="${selectedClass}" onclick="selectDeal(${index})" style="cursor: pointer;">
                    <td class="item-name" title="${trade.type_name}">${itemLabel}</td>
                    <td class="profit" title="Total profit: ${formatWithSpaces(Math.floor(trade.profit))} ISK">${formatNumber(trade.profit)}</td>
                    <td class="budget" title="Total cost: ${formatWithSpaces(Math.floor(trade.cost))} ISK">${formatNumber(trade.cost)}</td>
                    <td class="isk-jump" title="Profit per jump: ${formatNumber(trade.profit_per_jump)} ISK">${formatNumber(trade.profit_per_jump)}</td>
                    <td><span class="badge jumps-badge" title="Jumps one way">${trade.jumps}</span></td>
                    <td>${tripsBadge}</td>
                    <td><span class="badge amount-badge" title="${qtyTooltip}">${qtyDisplay}</span></td>
                    <td class="route">
                        <span class="route-station" title="Buy at: ${trade.from_station_name} (${formatSecurity(trade.from_security)})">
                            <span class="sec-dot ${getSecurityClass(trade.from_security)}"></span>${trade.from_station_name}
                        </span>
                        <span class="route-arrow">-></span>
                        <span class="route-station" title="Sell at: ${trade.to_station_name} (${formatSecurity(trade.to_security)})">
                            <span class="sec-dot ${getSecurityClass(trade.to_security)}"></span>${trade.to_station_name}
                        </span>
                    </td>
                </tr>
            `}).join('');
        }

        function truncate(str, len) {
            if (!str) return 'Unknown';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function formatAmountCompact(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // ========== Input Formatting ==========

        function setupFormattedInput(id) {
            const input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('blur', function() {
                const val = parseSpacedNumber(this.value);
                if (val > 0) {
                    this.value = formatWithSpaces(val);
                }
            });

            input.addEventListener('focus', function() {
                const val = parseSpacedNumber(this.value);
                if (val > 0) {
                    this.value = val;
                }
            });
        }

        // ========== Settings Persistence ==========

        const SETTINGS_KEY = 'eve_trading_settings';

        function saveSettings() {
            const settings = {
                // Market Settings
                groupSelect: document.getElementById('groupSelect')?.value,
                minProfit: document.getElementById('minProfit')?.value,
                cargoCapacity: document.getElementById('cargoCapacity')?.value,
                maxBudget: document.getElementById('maxBudget')?.value,
                maxTrips: document.getElementById('maxTrips')?.value,
                maxJumps: document.getElementById('maxJumps')?.value,
                
                // Route & Trade Options
                routeFlag: document.getElementById('routeFlag')?.value,
                tradeMode: document.getElementById('tradeMode')?.value,
                regionHighsec: document.getElementById('regionHighsec')?.checked,
                regionLowsec: document.getElementById('regionLowsec')?.checked,
                regionNullsec: document.getElementById('regionNullsec')?.checked,
                
                // Sort preferences
                currentSort: currentSort,
                sortDirection: sortDirection
            };
            
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(SETTINGS_KEY);
                if (!saved) return;
                
                const settings = JSON.parse(saved);
                
                // Market Settings
                if (settings.groupSelect) document.getElementById('groupSelect').value = settings.groupSelect;
                if (settings.minProfit) document.getElementById('minProfit').value = settings.minProfit;
                if (settings.cargoCapacity) document.getElementById('cargoCapacity').value = settings.cargoCapacity;
                if (settings.maxBudget) document.getElementById('maxBudget').value = settings.maxBudget;
                if (settings.maxTrips) document.getElementById('maxTrips').value = settings.maxTrips;
                if (settings.maxJumps) document.getElementById('maxJumps').value = settings.maxJumps;
                
                // Route & Trade Options
                if (settings.routeFlag) document.getElementById('routeFlag').value = settings.routeFlag;
                if (settings.tradeMode) document.getElementById('tradeMode').value = settings.tradeMode;
                if (settings.regionHighsec !== undefined) document.getElementById('regionHighsec').checked = settings.regionHighsec;
                if (settings.regionLowsec !== undefined) document.getElementById('regionLowsec').checked = settings.regionLowsec;
                if (settings.regionNullsec !== undefined) document.getElementById('regionNullsec').checked = settings.regionNullsec;
                
                // Sort preferences
                if (settings.currentSort) currentSort = settings.currentSort;
                if (settings.sortDirection) sortDirection = settings.sortDirection;
                
                console.log('Settings loaded from localStorage');
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // ========== Initialization ==========

        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings first
            loadSettings();
            
            // Setup formatted inputs
            setupFormattedInput('minProfit');
            setupFormattedInput('cargoCapacity');
            setupFormattedInput('maxBudget');

            // Sortable table headers
            document.querySelectorAll('.trades-table th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sort;
                    
                    if (currentSort === sortKey) {
                        sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                    } else {
                        document.querySelectorAll('.trades-table th.sortable').forEach(h => {
                            h.classList.remove('active', 'asc', 'desc');
                        });
                        currentSort = sortKey;
                        // Default directions - jumps/trips ascending, rest descending
                        const ascDefaults = ['jumps', 'trips'];
                        sortDirection = ascDefaults.includes(sortKey) ? 'asc' : 'desc';
                    }
                    
                    document.querySelectorAll('.trades-table th.sortable').forEach(h => {
                        h.classList.remove('active', 'asc', 'desc');
                        // Reset arrow
                        const arrow = h.querySelector('.sort-arrow');
                        if (arrow) arrow.textContent = 'v';
                    });
                    th.classList.add('active', sortDirection);
                    
                    // Update arrow direction
                    const arrow = th.querySelector('.sort-arrow');
                    if (arrow) {
                        arrow.textContent = sortDirection === 'asc' ? '^' : 'v';
                    }
                    
                    loadTrades();
                    saveSettings();
                });
            });

            // Reload on settings change and save
            ['maxBudget', 'cargoCapacity', 'maxTrips', 'maxJumps', 'minProfit', 'maxQty'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', function() {
                    loadTrades();
                    saveSettings();
                });
            });
            
            // Save settings on other control changes
            ['groupSelect', 'routeFlag', 'tradeMode'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveSettings);
            });
            
            // Save on region checkbox changes
            ['regionHighsec', 'regionLowsec', 'regionNullsec'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveSettings);
            });

            // Initial load
            loadTrades();
            updateStatus();
            
            // Load character info if logged in
            if (isLoggedIn) {
                loadCharacterStatus();
                // Refresh character status every 10 seconds
                characterStatusInterval = setInterval(loadCharacterStatus, 10000);
            }
        });

        // ========== Character Status Functions ==========

        let connectionRetries = 0;
        const MAX_RETRIES = 3;

        async function loadCharacterStatus() {
            if (!isLoggedIn) return;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch('/api/character/status', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.logged_in) {
                    characterData = data;
                    updateCharacterStatusUI(data);
                    connectionRetries = 0; // Reset on success
                    
                    // Update deal progress if tracking
                    if (activeDeal) {
                        updateDealProgress(data);
                    }
                } else if (data.needs_reauth) {
                    // Token expired and refresh failed
                    showConnectionError('Session expired. Please re-login.');
                    clearInterval(characterStatusInterval);
                }
            } catch (e) {
                connectionRetries++;
                console.error('Failed to load character status:', e, `(retry ${connectionRetries}/${MAX_RETRIES})`);
                
                if (connectionRetries >= MAX_RETRIES) {
                    showConnectionError('Connection lost. Retrying...');
                    connectionRetries = 0; // Reset and keep trying
                }
            }
        }

        function showConnectionError(message) {
            const locationEl = document.getElementById('charLocation');
            if (locationEl) {
                locationEl.innerHTML = `<span style="color: var(--danger);">[!] ${message}</span>`;
            }
        }

        function updateCharacterStatusUI(data) {
            // Update location
            const locationEl = document.getElementById('charLocation');
            if (locationEl) {
                const docked = data.is_docked ? '<span class="docked-badge">DOCKED</span>' : '<span class="in-space-badge">IN SPACE</span>';
                const locName = data.location_station_name || data.location_system_name || 'Unknown';
                const secClass = getSecurityClass(data.location_security || 0);
                locationEl.innerHTML = `<span class="sec-dot ${secClass}"></span>${locName} ${docked}`;
            }
            
            // Update ship
            const shipEl = document.getElementById('charShip');
            if (shipEl) {
                shipEl.textContent = `${data.ship_type_name} "${data.ship_name}"`;
            }
            
            // Update wallet (preserve last value if new value is 0 or missing)
            const walletEl = document.getElementById('charWallet');
            if (walletEl) {
                if (data.wallet && data.wallet > 0) {
                    lastKnownWallet = data.wallet;
                    walletEl.textContent = formatNumberCompact(data.wallet);
                } else if (lastKnownWallet) {
                    walletEl.textContent = formatNumberCompact(lastKnownWallet);
                }
            }
            
            // Update fees
            const brokerEl = document.getElementById('brokerFee');
            const taxEl = document.getElementById('salesTax');
            if (brokerEl) brokerEl.textContent = data.broker_fee.toFixed(1) + '%';
            if (taxEl) taxEl.textContent = data.sales_tax.toFixed(1) + '%';
        }

        async function refreshCharacter() {
            await loadCharacterStatus();
        }

        // ========== Sync Functions ==========

        async function syncWallet() {
            if (!isLoggedIn) return;
            
            await loadCharacterStatus();
            
            if (characterData && characterData.wallet) {
                const budgetInput = document.getElementById('maxBudget');
                // Convert to millions for the input field
                budgetInput.value = Math.floor(characterData.wallet / 1000000);
                loadTrades();
                
                showButtonFeedback('btnSyncWallet');
            }
        }

        async function syncCargo() {
            if (!isLoggedIn) return;
            
            try {
                const response = await fetch('/api/character/ship');
                const data = await response.json();
                
                if (data.cargo) {
                    const cargoInput = document.getElementById('cargoCapacity');
                    cargoInput.value = formatWithSpaces(Math.floor(data.cargo));
                    loadTrades();
                    
                    showButtonFeedback('btnSyncCargo');
                }
            } catch (e) {
                console.error('Failed to sync cargo:', e);
            }
        }

        async function clearDatabase() {
            try {
                const response = await fetch('/api/clear_db', { method: 'POST' });
                if (response.ok) {
                    allTradesCache = [];
                    renderTrades([]);
                    selectedDeal = null;
                    updateSelectedDealUI();
                    showButtonFeedback('btnClearDB');
                }
            } catch (e) {
                console.error('Failed to clear database:', e);
            }
        }

        function showButtonFeedback(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = 'OK';
                btn.style.background = 'var(--profit)';
                btn.style.color = 'var(--bg-dark)';
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1500);
            }
        }

        // ========== Deal Selection & Management ==========

        function selectDeal(index) {
            const trade = allTradesCache[index];
            if (!trade) return;
            
            // Immediately clear route warning before recalculation
            clearRouteWarning();
            
            selectedDeal = trade;
            selectedDeal.route_warning = null; // Reset warning
            updateSelectedDealUI();
            updateActionButtons();
            
            // Re-render to show selection
            renderTrades(allTradesCache);
            
            // Check route security in background
            checkRouteSecurity(trade);
        }
        
        async function checkRouteSecurity(trade) {
            if (!trade.from_system_id || !trade.to_system_id) return;
            
            try {
                const routeFlag = document.getElementById('routeFlag').value || 'secure';
                const response = await fetch('/api/check_route_security', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_system: trade.from_system_id,
                        to_system: trade.to_system_id,
                        route_flag: routeFlag
                    })
                });
                
                const data = await response.json();
                
                if (selectedDeal && selectedDeal.from_system_id === trade.from_system_id) {
                    selectedDeal.route_warning = data;
                    updateRouteWarning(data);
                }
            } catch (e) {
                console.error('Failed to check route security:', e);
            }
        }
        
        function updateRouteWarning(data) {
            const warningEl = document.getElementById('routeWarning');
            if (!warningEl) return;
            
            if (!data) {
                warningEl.style.display = 'none';
                warningEl.innerHTML = '';
                warningEl.className = 'route-warning';
            } else if (data.safe) {
                warningEl.style.display = 'block';
                warningEl.className = 'route-warning safe';
                warningEl.innerHTML = `Route is safe (highsec only)`;
            } else {
                const systems = data.dangerous_systems || [];
                const names = systems.map(s => `${s.name} (${s.security})`).join(', ');
                warningEl.style.display = 'block';
                warningEl.className = 'route-warning danger';
                warningEl.innerHTML = `Dangerous systems: ${names}`;
            }
        }
        
        function clearRouteWarning() {
            const warningEl = document.getElementById('routeWarning');
            if (warningEl) {
                warningEl.style.display = 'none';
                warningEl.innerHTML = '';
                warningEl.className = 'route-warning';
            }
        }

        function updateSelectedDealUI() {
            const content = document.getElementById('selectedDealContent');
            const clearBtn = document.getElementById('btnClearDeal');
            const quickActionsCard = document.getElementById('quickActionsCard');
            
            if (!selectedDeal) {
                content.innerHTML = `
                    <div class="no-deal">
                        <div class="no-deal-icon">&gt;&gt;</div>
                        <div>Click a trade to select it</div>
                    </div>
                `;
                if (clearBtn) clearBtn.classList.remove('visible');
                if (quickActionsCard) quickActionsCard.style.display = 'none';
                clearRouteWarning();
                return;
            }
            
            if (clearBtn) clearBtn.classList.add('visible');
            if (quickActionsCard) quickActionsCard.style.display = 'block';
            
            const d = selectedDeal;
            const volume = d.volume_m3 || (d.amount * (d.volume_per_unit || 0.01));
            content.innerHTML = `
                <div class="deal-item-name">${d.type_name}</div>
                <div class="deal-route">
                    <span title="${d.from_station_name} (${formatSecurity(d.from_security)})">
                        <span class="sec-dot ${getSecurityClass(d.from_security)}"></span>${truncate(d.from_station_name, 20)}
                    </span>
                    <span class="deal-route-arrow"></span>
                    <span title="${d.to_station_name} (${formatSecurity(d.to_security)})">
                        <span class="sec-dot ${getSecurityClass(d.to_security)}"></span>${truncate(d.to_station_name, 20)}
                    </span>
                </div>
                <div class="deal-stats">
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatNumber(d.buy_price)}</div>
                        <div class="deal-stat-label">Buy Price</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatNumber(d.sell_price)}</div>
                        <div class="deal-stat-label">Sell Price</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value profit">${formatNumber(d.profit)}</div>
                        <div class="deal-stat-label">Profit</div>
                    </div>
                </div>
                <div class="deal-stats">
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatNumber(d.cost)}</div>
                        <div class="deal-stat-label">Total Cost</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatAmountCompact(d.amount)}</div>
                        <div class="deal-stat-label">Amount</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatAmountCompact(volume)} m</div>
                        <div class="deal-stat-label">Volume</div>
                    </div>
                </div>
                <div class="deal-stats">
                    <div class="deal-stat">
                        <div class="deal-stat-value">${d.trips}</div>
                        <div class="deal-stat-label">Trips</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${d.jumps}</div>
                        <div class="deal-stat-label">Jumps</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${formatNumber(d.profit_per_jump)}</div>
                        <div class="deal-stat-label">ISK/Jump</div>
                    </div>
                </div>
            `;
        }

        function updateActionButtons() {
            // Quick Actions card visibility is now handled in updateSelectedDealUI
        }

        function clearDeal() {
            selectedDeal = null;
            activeDeal = null;
            document.getElementById('dealProgressCard').style.display = 'none';
            updateSelectedDealUI();
            updateActionButtons();
            renderTrades(allTradesCache);
        }

        // ========== In-Game Actions ==========

        async function setDestination(target) {
            if (!isLoggedIn || !selectedDeal) return;
            
            const stationId = target === 'buy' ? selectedDeal.from_station_id : selectedDeal.to_station_id;
            const routeFlag = document.getElementById('routeFlag').value;
            const btnId = target === 'buy' ? 'btnSetBuyDest' : 'btnSetSellDest';
            
            try {
                const response = await fetch('/api/set_destination', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        station_id: stationId,
                        route_flag: routeFlag
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showButtonFeedback(btnId);
                } else if (data.needs_reauth) {
                    showButtonError(btnId, 'Re-login');
                } else {
                    showButtonError(btnId, 'Failed');
                }
            } catch (e) {
                console.error('Failed to set destination:', e);
                showButtonError(btnId, 'Error');
            }
        }

        function showButtonError(btnId, text) {
            const btn = document.getElementById(btnId);
            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = text;
                btn.style.background = 'var(--danger)';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }
        }

        async function openMarketForDeal() {
            if (!isLoggedIn || !selectedDeal) return;
            
            try {
                const response = await fetch('/api/open_market', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type_id: selectedDeal.type_id })
                });
            } catch (e) {
                console.error('Failed to open market:', e);
            }
        }

        // ========== Deal Tracking ==========

        function startDeal() {
            if (!selectedDeal) return;
            
            activeDeal = {
                ...selectedDeal,
                startTime: Date.now(),
                startWallet: characterData ? characterData.wallet : 0,
                phase: 'travel_buy', // travel_buy, buying, travel_sell, selling, complete
                buyStationId: selectedDeal.from_station_id,
                sellStationId: selectedDeal.to_station_id
            };
            
            // Show progress card (don't auto-set destination)
            document.getElementById('dealProgressCard').style.display = 'block';
            updateDealProgressUI();
        }

        function updateDealProgress(charData) {
            if (!activeDeal) return;
            
            const currentStationId = charData.location_station_id;
            const isDocked = charData.is_docked;
            
            // Determine phase based on location
            if (activeDeal.phase === 'travel_buy') {
                if (isDocked && currentStationId === activeDeal.buyStationId) {
                    activeDeal.phase = 'buying';
                }
            } else if (activeDeal.phase === 'buying') {
                // Check if wallet decreased (bought something)
                if (charData.wallet < activeDeal.startWallet - activeDeal.cost * 0.5) {
                    activeDeal.phase = 'travel_sell';
                    activeDeal.boughtWallet = charData.wallet;
                    setDestination('sell');
                }
            } else if (activeDeal.phase === 'travel_sell') {
                if (isDocked && currentStationId === activeDeal.sellStationId) {
                    activeDeal.phase = 'selling';
                }
            } else if (activeDeal.phase === 'selling') {
                // Check if wallet increased (sold something)
                if (charData.wallet > activeDeal.boughtWallet + activeDeal.profit * 0.5) {
                    activeDeal.phase = 'complete';
                }
            }
            
            updateDealProgressUI();
        }

        function updateDealProgressUI() {
            if (!activeDeal) return;
            
            const phaseEl = document.getElementById('progressPhase');
            const percentEl = document.getElementById('progressPercent');
            const fillEl = document.getElementById('dealProgressFill');
            const timeEl = document.getElementById('estTimeLeft');
            const profitEl = document.getElementById('estProfit');
            
            let progress = 0;
            let phaseText = '';
            
            switch (activeDeal.phase) {
                case 'travel_buy':
                    progress = 10;
                    phaseText = '[>] Traveling to buy location...';
                    break;
                case 'buying':
                    progress = 35;
                    phaseText = '[!] At buy location - purchase items';
                    break;
                case 'travel_sell':
                    progress = 60;
                    phaseText = '[>] Traveling to sell location...';
                    break;
                case 'selling':
                    progress = 85;
                    phaseText = '[!] At sell location - sell items';
                    break;
                case 'complete':
                    progress = 100;
                    phaseText = '[+] Deal complete!';
                    break;
            }
            
            phaseEl.textContent = phaseText;
            percentEl.textContent = progress + '%';
            fillEl.style.width = progress + '%';
            
            // Estimate time remaining
            const elapsed = (Date.now() - activeDeal.startTime) / 1000;
            const totalEstimate = activeDeal.time_seconds || 300;
            const remaining = Math.max(0, totalEstimate - elapsed);
            timeEl.textContent = formatTime(remaining);
            
            profitEl.textContent = formatNumber(activeDeal.profit);
        }
    </script>
</body>
</html>

